import collections


Register = collections.namedtuple('Register', ('name', 'num', 'addr'))


# XXX Dummy decode method to be replaced
def decode(self, lo, hi):
    return (hi << 16) | lo
Register.decode = decode


# Register numbers are taken from the user manual, listing 5.12.3. All registers
# are 32-bits, stored as two 16-bit half-words in big endian order.
all_registers = [
    # register 0 is reserved
    # register 1 is PROG_VERSION, but unclear if we can access it
    Register(name='PROG_VERSION',    num=1,   addr=(2,3)),
    Register(name='MODE_REG',        num=2,   addr=(4,5)),
    Register(name='P_SOLL',          num=3,   addr=(6,7)),
    Register(name='P_NEW',           num=4,   addr=(8,9)),
    Register(name='V_SOLL',          num=5,   addr=(10,11)),
    Register(name='A_SOLL',          num=6,   addr=(12,13)),
    Register(name='T_SOLL',          num=7,   addr=(14,15)),
    Register(name='P_FNC',           num=8,   addr=(16,17)),
    Register(name='INDEX_OFFSET',    num=9,   addr=(18,19)),
    Register(name='P_IST',           num=10,  addr=(20,21)),
    Register(name='V_IST_16',        num=11,  addr=(22,23)),
    Register(name='V_IST',           num=12,  addr=(24,25)),
    Register(name='KVOUT',           num=13,  addr=(26,27)),
    Register(name='GEARF1',          num=14,  addr=(28,29)),
    Register(name='GEARF2',          num=15,  addr=(30,31)),
    Register(name='I2T',             num=16,  addr=(32,33)),
    Register(name='I2TLIM',          num=17,  addr=(34,35)),
    Register(name='UIT',             num=18,  addr=(36,37)),
    Register(name='UITLIM',          num=19,  addr=(38,39)),
    Register(name='FLWERR',          num=20,  addr=(40,41)),
    Register(name='U_24V',           num=21,  addr=(42,43)),
    Register(name='FLWERRMAX',       num=22,  addr=(44,45)),
    Register(name='UV_HANDLE',       num=23,  addr=(46,47)),
    Register(name='FNCERR',          num=24,  addr=(48,49)),
    Register(name='P_IST_TURNTAB',   num=25,  addr=(50,51)),
    Register(name='FNCERRMAX',       num=26,  addr=(52,53)),
    Register(name='TURNTAB_COUNT',   num=27,  addr=(54,55)),
    Register(name='MIN_P_PIST',      num=28,  addr=(56,57)),
    Register(name='DEGC',            num=29,  addr=(58,59)),
    Register(name='MAX_P_IST',       num=30,  addr=(60,61)),
    Register(name='DEGCMAX',         num=31,  addr=(62,63)),
    Register(name='ACC_EMERG',       num=32,  addr=(64,65)),
    Register(name='INPOSWIN',        num=33,  addr=(66,67)),
    Register(name='INPOSCNT',        num=34,  addr=(68,69)),
    Register(name='ERR_STAT',        num=35,  addr=(70,71)),
    Register(name='CNTRL_BITS',      num=36,  addr=(72,73)),
    Register(name='START_MODE',      num=37,  addr=(74,75)),
    Register(name='P_HOME',          num=38,  addr=(76,77)),
    Register(name='HW_SETUP',        num=39,  addr=(78,79)),
    Register(name='V_HOME',          num=40,  addr=(80,81)),
    Register(name='T_HOME',          num=41,  addr=(82,83)),
    Register(name='HOME_MODE',       num=42,  addr=(84,85)),
    Register(name='P_REG_P',         num=43,  addr=(86,87)),
    Register(name='V_REG_P',         num=44,  addr=(88,89)),
    Register(name='A_REG_P',         num=45,  addr=(90,91)),
    Register(name='T_REG_P',         num=46,  addr=(92,93)),
    Register(name='L_REG_P',         num=47,  addr=(94,95)),
    Register(name='Z_REG_P',         num=48,  addr=(96,97)),
    Register(name='POS0',            num=49,  addr=(98,99)),
    Register(name='CAPCOM0',         num=50,  addr=(100,101)),
    Register(name='POS1',            num=51,  addr=(102,103)),
    Register(name='CAPCOM1',         num=52,  addr=(104,105)),
    Register(name='POS2',            num=53,  addr=(106,107)),
    Register(name='CAPCOM2',         num=54,  addr=(108,109)),
    Register(name='POS3',            num=55,  addr=(110,111)),
    Register(name='CAPCOM3',         num=56,  addr=(112,113)),
    Register(name='POS4',            num=57,  addr=(114,115)),
    Register(name='CAPCOM4',         num=58,  addr=(116,117)),
    Register(name='POS5',            num=59,  addr=(118,119)),
    Register(name='CAPCOM5',         num=60,  addr=(120,121)),
    Register(name='POS6',            num=61,  addr=(122,123)),
    Register(name='CAPCOM6',         num=62,  addr=(124,125)),
    Register(name='POS7',            num=63,  addr=(126,127)),
    Register(name='CAPCOM7',         num=64,  addr=(128,129)),
    Register(name='VEL0',            num=65,  addr=(130,131)),
    Register(name='VEL1',            num=66,  addr=(132,133)),
    Register(name='VEL2',            num=67,  addr=(134,135)),
    Register(name='VEL3',            num=68,  addr=(136,137)),
    Register(name='VEL4',            num=69,  addr=(138,139)),
    Register(name='VEL5',            num=70,  addr=(140,141)),
    Register(name='VEL6',            num=71,  addr=(142,143)),
    Register(name='VEL7',            num=72,  addr=(144,145)),
    Register(name='ACC0',            num=73,  addr=(146,147)),
    Register(name='ACC1',            num=74,  addr=(148,149)),
    Register(name='ACC2',            num=75,  addr=(150,151)),
    Register(name='ACC3',            num=76,  addr=(152,153)),
    Register(name='TQ0',             num=77,  addr=(154,155)),
    Register(name='TQ1',             num=78,  addr=(156,157)),
    Register(name='TQ2',             num=79,  addr=(158,159)),
    Register(name='TQ3',             num=80,  addr=(160,161)),
    Register(name='LOAD0',           num=81,  addr=(162,163)),
    Register(name='LOAD1',           num=82,  addr=(164,165)),
    Register(name='LOAD2',           num=83,  addr=(166,167)),
    Register(name='LOAD3',           num=84,  addr=(168,169)),
    Register(name='ZERO0',           num=85,  addr=(170,171)),
    Register(name='ZERO1',           num=86,  addr=(172,173)),
    Register(name='ZERO2',           num=87,  addr=(174,175)),
    Register(name='ZERO3',           num=88,  addr=(176,177)),
    Register(name='MODE0',           num=89,  addr=(178,179)),
    Register(name='MODE1',           num=90,  addr=(180,181)),
    Register(name='MODE2',           num=91,  addr=(182,183)),
    Register(name='MODE3',           num=92,  addr=(184,185)),
    Register(name='HWI0',            num=93,  addr=(186,187)),
    Register(name='HWI1',            num=94,  addr=(188,189)),
    Register(name='HWI2',            num=95,  addr=(190,191)),
    Register(name='HWI3',            num=96,  addr=(192,193)),
    Register(name='HWI4',            num=97,  addr=(194,195)),
    Register(name='HWI5',            num=98,  addr=(196,197)),
    Register(name='HWI6',            num=99,  addr=(198,199)),
    Register(name='HWI70',           num=100, addr=(200,201)),
    Register(name='HWI80',           num=101, addr=(202,203)),
    Register(name='HWI90',           num=102, addr=(204,205)),
    Register(name='HWI100',          num=103, addr=(206,207)),
    Register(name='HWI110',          num=104, addr=(208,209)),
    Register(name='MAC00_TYP0',      num=105, addr=(210,211)),
    Register(name='MAC00_10',        num=106, addr=(212,213)),
    Register(name='MAC00_20',        num=107, addr=(214,215)),
    Register(name='MAC00_30',        num=108, addr=(216,217)),
    Register(name='MAC00_40',        num=109, addr=(218,219)),
    Register(name='MAC00_51',        num=110, addr=(220,221)),
    Register(name='MAC00_61',        num=111, addr=(222,223)),
    Register(name='MAC00_71',        num=112, addr=(224,225)),
    Register(name='MAC00_81',        num=113, addr=(226,227)),
    Register(name='MAC00_91',        num=114, addr=(228,229)),
    Register(name='MAC00_101',       num=115, addr=(230,231)),
    Register(name='MAC00_111',       num=116, addr=(232,233)),
    Register(name='MAC00_121',       num=117, addr=(234,235)),
    Register(name='MAC00_131',       num=118, addr=(236,237)),
    Register(name='MAC00_141',       num=119, addr=(238,239)),
    Register(name='MAC00_152',       num=120, addr=(240,241)),
    Register(name='KFF5',            num=121, addr=(242,243)),
    Register(name='KFF4',            num=122, addr=(244,245)),
    Register(name='KFF',             num=123, addr=(246,247)),
    Register(name='KFF2',            num=124, addr=(248,249)),
    Register(name='KFF1',            num=125, addr=(250,251)),
    Register(name='KFF0',            num=126, addr=(252,253)),
    Register(name='KVFX6',           num=127, addr=(254,255)),
    Register(name='KVFX5',           num=128, addr=(256,257)),
    Register(name='KVFX4',           num=129, addr=(258,259)),
    Register(name='KVFX3',           num=130, addr=(260,261)),
    Register(name='KVFX2',           num=131, addr=(262,263)),
    Register(name='KVFX1',           num=132, addr=(264,265)),
    Register(name='KVFY5',           num=133, addr=(266,267)),
    Register(name='KVFY',            num=134, addr=(268,269)),
    Register(name='KVFY3',           num=135, addr=(270,271)),
    Register(name='KVFY2',           num=136, addr=(272,273)),
    Register(name='KVFY1',           num=137, addr=(274,275)),
    Register(name='KVFY',            num=138, addr=(276,277)),
    Register(name='KVB4',            num=139, addr=(278,279)),
    Register(name='KVB3',            num=140, addr=(280,281)),
    Register(name='KVB2',            num=141, addr=(282,283)),
    Register(name='KVB1',            num=142, addr=(284,285)),
    Register(name='KVB0',            num=143, addr=(286,287)),
    Register(name='KIFX2',           num=144, addr=(288,289)),
    Register(name='KIFX1',           num=145, addr=(290,291)),
    Register(name='KIFY1',           num=146, addr=(292,293)),
    Register(name='KIFY0',           num=147, addr=(294,295)),
    Register(name='KIB1',            num=148, addr=(296,297)),
    Register(name='KIB0',            num=149, addr=(298,299)),
    # registers 150-154 are reserved
    Register(name='ID_RESERVED',     num=155, addr=(310,311)),
    Register(name='S_ORDER',         num=156, addr=(312,313)),
    Register(name='OUTLOOPDIV',      num=157, addr=(314,315)),
    Register(name='SAMPLE1',         num=158, addr=(316,317)),
    Register(name='SAMPLE2',         num=159, addr=(318,319)),
    Register(name='SAMPLE3',         num=160, addr=(320,321)),
    Register(name='SAMPLE4',         num=161, addr=(322,323)),
    Register(name='REC_CNT',         num=162, addr=(324,325)),
    Register(name='V_EXT',           num=163, addr=(326,327)),
    Register(name='GV_EXT',          num=164, addr=(328,329)),
    Register(name='G_FNC',           num=165, addr=(330,331)),
    Register(name='FNC_OUT',         num=166, addr=(332,333)),
    Register(name='FF_OUT',          num=167, addr=(334,335)),
    Register(name='VB_OUT',          num=168, addr=(336,337)),
    Register(name='VF_OUT',          num=169, addr=(338,339)),
    Register(name='ANINP',           num=170, addr=(340,341)),
    Register(name='ANINP_OFFSET',    num=171, addr=(342,343)),
    Register(name='ELDEG_OFFSET',    num=172, addr=(344,345)),
    Register(name='PHASE_COMP',      num=173, addr=(346,347)),
    Register(name='AMPLITUDE',       num=174, addr=(348,349)),
    Register(name='MAN_I_NOM',       num=175, addr=(350,351)),
    Register(name='MAN_ALPHA',       num=176, addr=(352,353)),
    Register(name='UMEAS',           num=177, addr=(354,355)),
    Register(name='I_NOM',           num=178, addr=(356,357)),
    Register(name='PHI_SOLL',        num=179, addr=(358,359)),
    Register(name='IA_SOLL',         num=180, addr=(360,361)),
    Register(name='IB_SOLL',         num=181, addr=(362,363)),
    Register(name='IC_SOLL',         num=182, addr=(364,365)),
    Register(name='IA_IST',          num=183, addr=(366,367)),
    Register(name='IB_IST',          num=184, addr=(368,369)),
    Register(name='IC_IST',          num=185, addr=(370,371)),
    Register(name='IA_OFFSET',       num=186, addr=(372,373)),
    Register(name='IB_OFFSET',       num=187, addr=(374,375)),
    Register(name='KIA',             num=188, addr=(376,377)),
    Register(name='KIB',             num=189, addr=(378,379)),
    Register(name='ELDEG_IST',       num=190, addr=(380,381)),
    Register(name='V_ELDEG',         num=191, addr=(382,383)),
    Register(name='UA_VAL',          num=192, addr=(384,385)),
    Register(name='UB_VAL',          num=193, addr=(386,387)),
    Register(name='UC_VAL',          num=194, addr=(388,389)),
    Register(name='EMK_A',           num=195, addr=(390,391)),
    Register(name='EMK_B',           num=196, addr=(392,393)),
    Register(name='EMK_C',           num=197, addr=(394,395)),
    Register(name='U_BUS',           num=198, addr=(396,397)),
    Register(name='U_BUS_OFFSET',    num=199, addr=(398,399)),
    Register(name='TC0_CV1',         num=200, addr=(400,401)),
    Register(name='TC0_CV2',         num=201, addr=(402,403)),
    Register(name='MY_ADDR',         num=202, addr=(404,405)),
    Register(name='MOTOR_TYPE',      num=203, addr=(406,407)),
    Register(name='SERIAL_NUMBER',   num=204, addr=(408,409)),
    Register(name='HW_VERSION',      num=205, addr=(410,411)),
    Register(name='CHKSUM',          num=206, addr=(412,413)),
    Register(name='USEROUTVAL',      num=207, addr=(414,415)),
    Register(name='COMM_ERRS',       num=208, addr=(416,417)),
    Register(name='INDEX_IST',       num=209, addr=(418,419)),
    Register(name='HW_PLIM',         num=210, addr=(420,421)),
    Register(name='COMMAND_REG',     num=211, addr=(422,423)),
    Register(name='UART0_SETUP',     num=212, addr=(424,425)),
    Register(name='UART1_SETUP',     num=213, addr=(426,427)),
    Register(name='EXTENC_BITS',     num=214, addr=(428,429)),
    Register(name='INPUT_LEVELS',    num=215, addr=(430,431)),
    Register(name='ANINP1',          num=216, addr=(432,433)),
    Register(name='ANINP1_OFFSET',   num=217, addr=(434,435)),
    Register(name='ANINP2',          num=218, addr=(436,437)),
    Register(name='ANINP2_OFFSET',   num=219, addr=(438,439)),
    Register(name='ANINP3',          num=220, addr=(440,441)),
    Register(name='ANINP3_OFFSET',   num=221, addr=(442,443)),
    Register(name='IOSETUP',         num=222, addr=(444,445)),
    Register(name='ANOUT1',          num=223, addr=(446,447)),
    Register(name='ANOUT1_OFFSET',   num=224, addr=(448,449)),
    Register(name='P_OFFSET',        num=225, addr=(450,451)),
    Register(name='P_MULTITURN',     num=226, addr=(452,453)),
    Register(name='AIFILT_MAXSLOPE', num=227, addr=(454,455)),
    Register(name='AIFILT_FILTFACT', num=228, addr=(456,457)),
    Register(name='P_QUICK',         num=229, addr=(458,459)),
    Register(name='XREG_ADDR',       num=230, addr=(460,461)),
    Register(name='XREG_DATA',       num=231, addr=(462,463)),
]

# NOTE:
# Additional modbus module registers are defined in listing 7.3.1 of the
# MAC00-EC4/-EC41 user manual.


# Create lookup table by name
_registers_by_name = { reg.name: reg for reg in all_registers }


# Export all registers
globals().update(_registers_by_name)


# Look up by name
def register_for_name(name):
    return _registers_by_name[name]


# Look up by address
def register_for_address(addr):
    lo, hi = 0, len(all_registers)
    while lo < hi:
        mid = (lo+hi)//2
        if all_registers[mid].addr[-1] < addr:
            lo = mid+1
        else:
            hi = mid

    if addr not in all_registers[lo].addr:
        raise ValueError('Register not found for this address')
    return all_registers[lo]
